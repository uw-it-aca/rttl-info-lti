{% extends 'rttlinfo/base_blti.html' %}

{% load static %}

<!-- Skip link for keyboard navigation -->
<a href="#main-content" class="sr-only sr-only-focusable">Skip to main content</a>

<style>
  .sr-only-focusable:focus {
    position: absolute;
    left: 6px;
    top: 7px;
    z-index: 1000;
    background: #fff;
    padding: 6px 10px;
    text-decoration: none;
    border: 1px solid #ccc;
  }
</style>

{% block content %}

{% csrf_token %}
<div class="canvas-rttlinfo-container" id="main-content">

  <div class="container-fluid mt-4">

    <div class="row">
      <div class="col">
        <h1 class="h2 mb-3" id="uw_rttlinfo_header">
          Request a JupyterHub
        </h1>

        <div class="p-3 mx-3 mb-5 rounded" style="background: #f4f2ea;">
          <p class="lead">
            Request a JupyterHub environment for your course. Once submitted, your request will be reviewed and you'll be notified when your JupyterHub is ready.
          </p>
          <div class="text-center">
            <a class="btn btn-outline-secondary" href="https://uwconnect.uw.edu/it?id=kb_article_view&sysparm_article=KB0034609" target="_blank" aria-label="Learn more about JupyterHub (opens in new window)">Learn more about JupyterHub</a>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-5">
      <div class="col-md-8 mx-auto">
        <div class="card">
          <div class="card-header">
            <h2 class="h4 mb-0">Hub Request Form</h2>
          </div>
          <div class="card-body">
            <form method="post">
              {% csrf_token %}

              <!-- Course Information Section -->
              <div class="mb-4">
                <h3 class="h5 mb-3 text-primary">Course Information</h3>
                <strong> {{ blti_data.course_long_name }}</strong>
                <small class="form-text text-muted d-block mb-2">Requesting as {{ blti_data.user_email}}</small>
              </div>

              <!-- Resource Requirements Section -->
              <div class="mb-4">
                <h3 class="h5 mb-3 text-primary">Resource Requirements</h3>
                <small class="form-text text-muted d-block mb-2">Computational resources to be allocated for each user's instance.</small>
                <!-- CPU Request (full width for radio buttons) -->
                <fieldset class="form-group mb-3 border rounded p-3" style="background-color: #f8f9fa;">
                    <div class="form-label h6 mb-2" id="{{ form.cpu_request.id_for_label }}_legend"><strong>{{ form.cpu_request.label }}</strong></div>
                    {% if form.cpu_request.help_text %}
                        <small class="form-text text-muted">{{ form.cpu_request.help_text }}</small>
                    {% endif %}
                  <div class="d-flex mb-2" style="gap: 2rem;" role="radiogroup" aria-labelledby="{{ form.cpu_request.id_for_label }}_legend">
                      {% for radio in form.cpu_request %}
                          <div class="form-check">
                              {{ radio.tag }}
                              <label class="form-check-label" for="{{ radio.id_for_label }}">
                                  {{ radio.choice_label }}
                              </label>
                          </div>
                      {% endfor %}
                  </div>
                    {% if form.cpu_request.errors %}
                        <div class="invalid-feedback d-block" role="alert" id="{{ form.cpu_request.id_for_label }}_errors">
                          {% for error in form.cpu_request.errors %}
                            {{ error }}
                          {% endfor %}
                        </div>
                    {% endif %}
                </fieldset>
                <!-- Memory Request (full width for radio buttons) -->
                <fieldset class="form-group mb-3 border rounded p-3" style="background-color: #f8f9fa;">
                    <div class="form-label h6 mb-2" id="{{ form.memory_request.id_for_label }}_legend"><strong>{{ form.memory_request.label }}</strong></div>
                      {% if form.memory_request.help_text %}
                        <small class="form-text text-muted">{{ form.memory_request.help_text }}</small>
                    {% endif %}
                  <div class="d-flex mb-2" style="gap: 2rem;" role="radiogroup" aria-labelledby="{{ form.memory_request.id_for_label }}_legend">
                      {% for radio in form.memory_request %}
                          <div class="form-check">
                              {{ radio.tag }}
                              <label class="form-check-label" for="{{ radio.id_for_label }}">
                                  {{ radio.choice_label }}
                              </label>
                          </div>
                      {% endfor %}
                  </div>
                    {% if form.memory_request.errors %}
                        <div class="invalid-feedback d-block" role="alert" id="{{ form.memory_request.id_for_label }}_errors">
                          {% for error in form.memory_request.errors %}
                            {{ error }}
                          {% endfor %}
                        </div>
                    {% endif %}
                </fieldset>
                <!-- Storage Request (full width for radio buttons) -->
                <fieldset class="form-group mb-3 border rounded p-3" style="background-color: #f8f9fa;">
                    <div class="form-label h6 mb-2" id="{{ form.storage_request.id_for_label }}_legend"><strong>{{ form.storage_request.label }}</strong></div>
                    {% if form.storage_request.help_text %}
                        <small class="form-text text-muted">{{ form.storage_request.help_text }}</small>
                    {% endif %}
                  <div class="d-flex mb-2" style="gap: 2rem;" role="radiogroup" aria-labelledby="{{ form.storage_request.id_for_label }}_legend">
                      {% for radio in form.storage_request %}
                          <div class="form-check">
                              {{ radio.tag }}
                              <label class="form-check-label" for="{{ radio.id_for_label }}">
                                  {{ radio.choice_label }}
                              </label>
                          </div>
                      {% endfor %}
                  </div>
                    {% if form.storage_request.errors %}
                        <div class="invalid-feedback d-block" role="alert" id="{{ form.storage_request.id_for_label }}_errors">
                          {% for error in form.storage_request.errors %}
                            {{ error }}
                          {% endfor %}
                        </div>
                    {% endif %}
                </fieldset>
              </div>

              <!-- Container Image Section -->
              <div class="mb-4">
                <h3 class="h5 mb-3 text-primary">Container Image</h3>
                
                <!-- Container Image Choice (radio buttons) -->
                <div class="form-group mb-3">
                  {% if form.container_image.help_text %}
                    <small class="form-text text-muted d-block mb-2">{{ form.container_image.help_text }}</small>
                  {% endif %}
                  <div class="d-flex flex-column gap-2">
                    {% for radio in form.container_image %}
                      <div class="form-check">
                        {{ radio.tag }}
                        <label class="form-check-label" for="{{ radio.id_for_label }}">
                          {{ radio.choice_label|safe }}
                        </label>
                      </div>
                    {% endfor %}
                  </div>
                  {% if form.container_image.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.container_image.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Custom Image Fields (shown when Custom image is selected) -->
                <div id="custom-image-fields" style="display: none;">
                  <div class="alert alert-info" role="alert">
                    <strong>Custom Image Requirements:</strong> 
                    Please ensure your custom image is compatible with JupyterHub. We recommend basing your image on one of our 
                    <a href="https://github.com/uw-it-aca/rttl-notebooks" target="_blank" aria-label="Supported images (opens in new window)">supported images</a>.
                    <a href="https://jupyter-docker-stacks.readthedocs.io/en/latest/index.html" target="_blank" aria-label="Jupyter Docker Stacks documentation (opens in new window)">Start here</a> 
                    for guidance and best practices around building custom images. Per UW-IT policy, instructors who choose the Custom 
                    Image option are responsible for all support, testing, troubleshooting, bug fixing, and updates; 
                    UW-IT cannot provide support outside of general cloud platform support. 
                  </div>
                  
                  <div class="row">
                    <!-- Custom Image URL -->
                    <div class="col-md-8">
                      <div class="form-group mb-3">
                        <label for="{{ form.custom_image_url.id_for_label }}" class="form-label">
                          <strong>{{ form.custom_image_url.label }}</strong>
                          <span class="text-danger" aria-label="required">*</span>
                        </label>
                        {% if form.custom_image_url.help_text %}
                          <small class="form-text text-muted d-block mb-2">{{ form.custom_image_url.help_text }}</small>
                        {% endif %}
                        {{ form.custom_image_url }}
                        {% if form.custom_image_url.errors %}
                          <div class="invalid-feedback d-block">
                            {% for error in form.custom_image_url.errors %}{{ error }}{% endfor %}
                          </div>
                        {% endif %}
                      </div>
                    </div>

                    <!-- Custom Image Tag -->
                    <div class="col-md-4">
                      <div class="form-group mb-3">
                        <label for="{{ form.custom_image_tag.id_for_label }}" class="form-label">
                          <strong>{{ form.custom_image_tag.label }}</strong>
                          <span class="text-danger" aria-label="required">*</span>
                        </label>
                        {% if form.custom_image_tag.help_text %}
                          <small class="form-text text-muted d-block mb-2">{{ form.custom_image_tag.help_text }}</small>
                        {% endif %}
                        {{ form.custom_image_tag }}
                        {% if form.custom_image_tag.errors %}
                          <div class="invalid-feedback d-block">
                            {% for error in form.custom_image_tag.errors %}{{ error }}{% endfor %}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  // Handle container image toggle
                  const radioButtons = document.querySelectorAll('input[name="container_image"]');
                  const customFields = document.getElementById('custom-image-fields');
                  
                  function toggleCustomFields() {
                    const selectedValue = document.querySelector('input[name="container_image"]:checked')?.value;
                    if (selectedValue === 'custom') {
                      customFields.style.display = 'block';
                    } else {
                      customFields.style.display = 'none';
                    }
                  }
                  
                  radioButtons.forEach(function(radio) {
                    radio.addEventListener('change', toggleCustomFields);
                  });
                  
                  // Check initial state
                  toggleCustomFields();

                  // Handle git repository section chevron rotation
                  const gitRepositorySection = document.getElementById('gitRepositorySection');
                  if (gitRepositorySection) {
                    gitRepositorySection.addEventListener('show.bs.collapse', function () {
                      document.getElementById('gitRepoChevron').textContent = '▼';
                      document.getElementById('git-repo-toggle').setAttribute('aria-expanded', 'true');
                    });
                    
                    gitRepositorySection.addEventListener('hide.bs.collapse', function () {
                      document.getElementById('gitRepoChevron').textContent = '▶';
                      document.getElementById('git-repo-toggle').setAttribute('aria-expanded', 'false');
                    });
                  }
                });
              </script>

              <!-- Features Section -->
              <div class="mb-4">
                <h3 class="h5 mb-3 text-primary">Features</h3>
                
                <!-- NFS Feature -->
                <div class="form-group mb-3">
                  <div class="form-check">
                    {{ form.feature_nfs }}
                    <label class="form-check-label" for="{{ form.feature_nfs.id_for_label }}">
                      <strong>{{ form.feature_nfs.label }}</strong>
                    </label>
                    {% if form.feature_nfs.help_text %}
                      <small class="form-text text-muted d-block">{{ form.feature_nfs.help_text }}</small>
                    {% endif %}
                  </div>
                  {% if form.feature_nfs.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.feature_nfs.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- BinderHub Feature -->
              <!-- 
                <div class="form-group mb-3">
                  <div class="form-check">
                    {{ form.feature_binderhub }}
                    <label class="form-check-label" for="{{ form.feature_binderhub.id_for_label }}">
                      <strong>{{ form.feature_binderhub.label }}</strong>
                    </label>
                    {% if form.feature_binderhub.help_text %}
                      <small class="form-text text-muted d-block">{{ form.feature_binderhub.help_text }}</small>
                    {% endif %}
                  </div>
                  {% if form.feature_binderhub.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.feature_binderhub.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>  -->

              <!-- Git Repository Section -->
              <div class="mb-4">
                <h3 class="h5 mb-3 text-primary">
                  <button class="btn btn-link p-0 text-primary text-decoration-none h5" type="button" data-bs-toggle="collapse" data-bs-target="#gitRepositorySection" aria-expanded="false" aria-controls="gitRepositorySection" style="font-size: inherit; font-weight: inherit;" id="git-repo-toggle">
                    <span id="gitRepoChevron" aria-hidden="true">▶</span>
                    Git Repository (Optional)
                  </button>
                </h3>
                
                <div class="collapse" id="gitRepositorySection">
                  <!-- Git Repository URI -->
                  <div class="form-group mb-3">    
                        <label for="{{ form.gitpuller_uri.id_for_label }}" class="form-label">
                          <strong>{{ form.gitpuller_uri.label }}</strong>
                          {% if form.gitpuller_uri.field.required %}<span class="text-danger" aria-label="required">*</span>{% endif %}
                        </label>
                    {% if form.gitpuller_uri.help_text %}
                      <small class="form-text text-muted d-block mb-2">{{ form.gitpuller_uri.help_text|safe }}</small>
                    {% endif %}
                    {{ form.gitpuller_uri }}
                    {% if form.gitpuller_uri.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.gitpuller_uri.errors %}{{ error }}{% endfor %}
                      </div>
                    {% endif %}
                  </div>

                  <div class="row">
                    <!-- Git Branch/Tag -->
                    <div class="col-md-6">
                      <div class="form-group mb-3">
                        <label for="{{ form.gitpuller_tag.id_for_label }}" class="form-label">
                          <strong>{{ form.gitpuller_tag.label }}</strong>
                          {% if form.gitpuller_tag.field.required %}<span class="text-danger" aria-label="required">*</span>{% endif %}
                        </label>
                        {% if form.gitpuller_tag.help_text %}
                          <small class="form-text text-muted d-block mb-2">{{ form.gitpuller_tag.help_text }}</small>
                        {% endif %}
                        {{ form.gitpuller_tag }}
                        {% if form.gitpuller_tag.errors %}
                          <div class="invalid-feedback d-block">
                            {% for error in form.gitpuller_tag.errors %}{{ error }}{% endfor %}
                          </div>
                        {% endif %}
                      </div>
                    </div>

                    <!-- Sync Directory -->
                    <div class="col-md-6">
                      <div class="form-group mb-3">
                        <label for="{{ form.gitpuller_sync_dir.id_for_label }}" class="form-label">
                          <strong>{{ form.gitpuller_sync_dir.label }}</strong>
                          {% if form.gitpuller_sync_dir.field.required %}<span class="text-danger" aria-label="required">*</span>{% endif %}
                        </label>
                        {% if form.gitpuller_sync_dir.help_text %}
                          <small class="form-text text-muted d-block mb-2">{{ form.gitpuller_sync_dir.help_text }}</small>
                        {% endif %}
                        {{ form.gitpuller_sync_dir }}
                        {% if form.gitpuller_sync_dir.errors %}
                          <div class="invalid-feedback d-block">
                            {% for error in form.gitpuller_sync_dir.errors %}{{ error }}{% endfor %}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Additional Information Section -->
              <div class="mb-4">
                <h3 class="h5 mb-3 text-primary">Additional Information</h3>

                <!-- Additional Hub Admins (CourseConfigurationForm) -->
                {% if form.additional_admins %}
                <div class="form-group mb-3">
                  <label for="{{ form.additional_admins.id_for_label }}" class="form-label">
                    <strong>{{ form.additional_admins.label }}</strong>
                    {% if form.additional_admins.field.required %}<span class="text-danger" aria-label="required">*</span>{% endif %}
                  </label>
                  {% if form.additional_admins.help_text %}
                    <small class="form-text text-muted d-block mb-2">{{ form.additional_admins.help_text }}</small>
                  {% endif %}
                  {{ form.additional_admins }}
                  {% if form.additional_admins.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.additional_admins.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>
                {% endif %}

                <!-- Configuration Comments (CourseConfigurationForm) -->
                {% if form.configuration_comments %}
                <div class="form-group mb-3">
                  <label for="{{ form.configuration_comments.id_for_label }}" class="form-label">
                    <strong>{{ form.configuration_comments.label }}</strong>
                    {% if form.configuration_comments.field.required %}<span class="text-danger" aria-label="required">*</span>{% endif %}
                  </label>
                  {% if form.configuration_comments.help_text %}
                    <small class="form-text text-muted d-block mb-2">{{ form.configuration_comments.help_text }}</small>
                  {% endif %}
                  {{ form.configuration_comments }}
                  {% if form.configuration_comments.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.configuration_comments.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              
              {% if form.non_field_errors %}
                <div class="alert alert-danger" role="alert" aria-live="polite">
                  {% for error in form.non_field_errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
              
              <div class="d-flex justify-content-between align-items-center mt-4">
                <a href="{% url 'home' %}" class="btn btn-outline-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Submit Request</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
