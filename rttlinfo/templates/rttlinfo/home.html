{% extends 'rttlinfo/base_blti.html' %}

{% load static %}

{% csrf_token %}

<!-- Skip link for keyboard navigation -->
<a href="#main-content" class="sr-only sr-only-focusable">Skip to main content</a>

{% block content %}
<div class="canvas-rttlinfo-container" id="main-content">

  <div class="container-fluid mt-4">

    <div class="row">
      <div class="col">
        <h1 class="h2 mb-3" id="uw_rttlinfo_header">
          UW-IT JupyterHub for Teaching and Learning
        </h1>

        <div class="p-3 mx-3 mb-5 rounded" style="background: #f4f2ea;">
          <p class="lead">
            JupyterHub for Teaching gives users access to Jupyter Notebook environments (computational environments and resources) without the hassle of installation and maintenance tasks. Instructors can make individual workspaces available via JupyterHub to students using shared resources, which can be managed efficiently by system administrators.
          </p>
          <div class="text-center">
            <a class="btn btn-primary" href="https://uwconnect.uw.edu/it?id=kb_article_view&sysparm_article=KB0034609" target="_blank">Learn more</a>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-5">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h2 class="h4 mb-0">JupyterHub status for {{ course_long_name }}</h2>
          </div>
          <div class="card-body">
            <!-- Loading spinner - shown by default -->
            <div id="hub-loading" class="text-center py-5" role="status" aria-live="polite" aria-label="Loading JupyterHub status">
              <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;" aria-hidden="true">
                <span class="sr-only">Loading...</span>
              </div>
              <p class="lead" id="loading-text">Fetching Hub data...</p>
            </div>

            <!-- Error state - hidden by default -->
            <div id="hub-error" class="alert alert-danger d-none" role="alert" aria-live="polite">
              <h4 class="alert-heading">Error Loading Hub Data</h4>
              <p>We were unable to load the JupyterHub status for this course. Please try refreshing the page.</p>
              <button class="btn btn-outline-danger" onclick="loadHubData()" aria-describedby="hub-error">Retry</button>
            </div>

            <!-- Main content - hidden by default, will be shown when data loads -->
            <div id="hub-content" class="d-none" role="region" aria-live="polite" aria-label="JupyterHub status information">
              <div class="row">
                <div class="col-md-8">
                  <p class="lead" id="hub-status-text" role="status">
                    <!-- Status text will be populated by JavaScript -->
                  </p>
                  
                  <!-- Hub details card - will be shown/hidden by JavaScript -->
                  <div class="card mb-3 d-none" id="hub-details-card" role="region" aria-labelledby="hub-details-heading">
                    <div class="card-header">
                      <h3 class="h5 mb-0" id="hub-details-heading">Hub Details</h3>
                    </div>
                    <ul class="list-group list-group-flush">
                      <li class="list-group-item">
                        <strong>Status:</strong> <span id="hub-status-value" aria-label="Current hub status"></span>
                      </li>
                      <li class="list-group-item d-none" id="hub-message-item">
                        <strong>Message:</strong> <span id="hub-message-value" aria-label="Status message"></span>
                      </li>
                      <li class="list-group-item d-none" id="hub-url-item">
                        <strong>URL:</strong> <a href="#" target="_blank" class="d-inline-block" id="hub-url-link" aria-label="JupyterHub URL"></a>
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card">
                    <div class="card-header">
                      <h3 class="h5 mb-0" id="actions-heading">Actions</h3>
                    </div>
                    <div class="card-body" id="hub-actions" role="region" aria-labelledby="actions-heading">
                      <!-- Action buttons will be populated by JavaScript -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Global variables from Django template
const COURSE_SIS_ID = '{{ course_sis_id }}';
const COURSE_LONG_NAME = '{{ course_long_name }}';
const IS_INSTRUCTOR = {{ is_instructor|yesno:"true,false" }};
const IS_ADMIN = {{ is_admin|yesno:"true,false" }};
const IS_TA = {{ is_ta|yesno:"true,false" }};
const IS_ELIGIBLE = {{ is_eligible|yesno:"true,false" }};

// Get CSRF token
function getCSRFToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
         document.querySelector('meta[name=csrf-token]')?.getAttribute('content') ||
         '{{ csrf_token }}';
}

function loadHubData() {
  // Show loading spinner, hide other content
  document.getElementById('hub-loading').classList.remove('d-none');
  document.getElementById('hub-content').classList.add('d-none');
  document.getElementById('hub-error').classList.add('d-none');

  // Make AJAX call to fetch hub data
  fetch(`{% url 'hub-data-api' %}?course_sis_id=${encodeURIComponent(COURSE_SIS_ID)}`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCSRFToken(),
      'X-Requested-With': 'XMLHttpRequest'
    },
    credentials: 'same-origin'
  })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      // Hide loading spinner
      document.getElementById('hub-loading').classList.add('d-none');
      
      // Show main content
      document.getElementById('hub-content').classList.remove('d-none');
      
      // Populate the UI with the fetched data
      updateHubUI(data);
    })
    .catch(error => {
      console.error('Error loading hub data:', error);
      
      // Hide loading spinner
      document.getElementById('hub-loading').classList.add('d-none');
      
      // Show error message
      document.getElementById('hub-error').classList.remove('d-none');
    });
}

function updateHubUI(hubData) {
  const statusText = document.getElementById('hub-status-text');
  const detailsCard = document.getElementById('hub-details-card');
  const actionsContainer = document.getElementById('hub-actions');

  // console.log("Hub Data:", hubData);
  // Hub states for status text display
  if (hubData.rttl_hub_exists && hubData.rttl_hub_deployed) {
    // Hub data was found and 'rttl_hub_deployed' is true
    statusText.textContent = 'A JupyterHub is available for this course. You can access it now!';
  } else if (hubData.rttl_hub_exists && hubData.rttl_hub_status === 'requested') {
    // Hub data was found and 'rttl_hub_status' is 'requested' (ie, the initial state before approval)
    statusText.textContent = 'A JupyterHub has been requested for this course.';
  } else if (hubData.rttl_hub_exists) {
    // Hub data was found but not yet deployed - display the latest status message
    statusText.textContent = 'JupyterHub information was found for this course - please see latest status below.';
  } else if (!IS_ELIGIBLE) {
    // No hub data was found but the course is not eligible for a JupyterHub
    statusText.innerHTML = 'This course is not eligible for a JupyterHub. You can email <a href="mailto:help@uw.edu">help@uw.edu</a> with questions or review the eligibility criteria in <a href="https://uwconnect.uw.edu/it?id=kb_article_view&sysparm_article=KB0034609" target="_blank">UW Connect</a>';
  } else {
    // No hub data was found and the course is eligible for a JupyterHub - options depend on user role
    if (IS_INSTRUCTOR || IS_ADMIN || IS_TA) {
      statusText.innerHTML = 'No JupyterHub has been requested for this course yet. You can <a href="{% url "hub-request" %}" target="_self">request a JupyterHub</a> now.';
    } else {
      statusText.textContent = 'This course is not using JupyterHub. Please contact your instructor or TA for more information.';
    }
  }

  // Show/hide and populate hub details card
  if (hubData.rttl_hub_exists) {
    detailsCard.classList.remove('d-none');
    
    // Update status value
    document.getElementById('hub-status-value').textContent = hubData.rttl_hub_status || 'Unknown';
    
    // Show/hide message
    const messageItem = document.getElementById('hub-message-item');
    const messageValue = document.getElementById('hub-message-value');
    if (hubData.rttl_hub_status_message) {
      // messageValue.textContent = hubData.rttl_hub_status_message;
      messageValue.innerHTML = hubData.rttl_hub_status_message;
      messageItem.classList.remove('d-none');
    } else {
      messageItem.classList.add('d-none');
    }
    
    // Show/hide URL
    const urlItem = document.getElementById('hub-url-item');
    const urlLink = document.getElementById('hub-url-link');
    if (hubData.rttl_hub_url && hubData.rttl_hub_deployed) {
      urlLink.href = hubData.rttl_hub_url;
      urlLink.textContent = hubData.rttl_hub_url;
      urlItem.classList.remove('d-none');
    } else {
      urlItem.classList.add('d-none');
    }
  } else {
    detailsCard.classList.add('d-none');
  }

  // Populate actions
  actionsContainer.innerHTML = generateActionButtons(hubData);
}

function generateActionButtons(hubData) {
  let buttons = '';

  // Hub states for button display
  if (hubData.rttl_hub_exists && hubData.rttl_hub_deployed) {
    // Hub data was found and 'rttl_hub_deployed' is true show launch buttons
    buttons += `<a href="${hubData.rttl_hub_url}" class="btn btn-primary btn-block mb-2" target="_blank" aria-label="Launch JupyterHub in new window">Launch JupyterHub</a>`;
    //Show admin button if user is eligible
    if (IS_INSTRUCTOR || IS_ADMIN || IS_TA) {
      // Note: admins in the course are not guaranteed to have admin access to the hub, so this may be an area for future improvement
      // One option would be a get_admins endpoint in the RTTL API to query the hub and return a list of users with admin access
      buttons += `<a href="${hubData.rttl_hub_url}/hub/admin" class="btn btn-primary btn-block mb-2" target="_blank" aria-label="Launch JupyterHub Admin interface in new window">Launch JupyterHub Admin interface</a>`;
      // manage feature is not implemented yet
      // buttons += `<a href="{% url 'hub-manage' %}?course_sis_id=${COURSE_SIS_ID}" class="btn btn-primary btn-block mb-2" target="_self">Manage Hub Request</a>`;
    }
  } else if (hubData.rttl_hub_exists && hubData.rttl_hub_status === 'archived') {
    // Hub exists and is archived
    // Don't show buttons that are not actionable
    // buttons += '<button class="btn btn-secondary btn-block mb-2" disabled>Hub has been archived</button>';
  } else if (hubData.rttl_hub_exists && hubData.rttl_hub_status === 'blocked') {
    // Hub data exists but is not approved
    // Don't show buttons that are not actionable
    // buttons += '<button class="btn btn-secondary btn-block mb-2" disabled>Hub not available</button>';
  } else if (hubData.rttl_hub_exists && ['requested', 'pending'].includes(hubData.rttl_hub_status)) {
    // Hub request has been made and is requsted or pending
    if (IS_INSTRUCTOR || IS_ADMIN || IS_TA) {
      // manage feature is not implemented yet
      // Don't show buttons that are not actionable
      // buttons += `<a href="{% url 'hub-manage' %}?course_sis_id=${COURSE_SIS_ID}" class="btn btn-primary btn-block mb-2" target="_self">Manage Hub Request</a>`;
      // buttons += '<button class="btn btn-secondary btn-block mb-2" disabled>Request Pending</button>';
    } else {
      // Don't show buttons that are not actionable
      // buttons += '<button class="btn btn-secondary btn-block mb-2" disabled>Request Pending</button>';
    }
  } else if (IS_ELIGIBLE) {
    // Hub does not exist and no request found, but is eligible to request one
    if (IS_INSTRUCTOR || IS_ADMIN || IS_TA) {
      buttons += `<a href="{% url 'hub-request' %}" class="btn btn-primary btn-block mb-2" target="_self">Request a JupyterHub</a>`;
    } else {
      // Note: we're gating student access to the tool at the infohub level, but students could still get here if the tool is installed in a course
      // Voting not implemented yet      
      // buttons += `<a href="{% url 'hub-request' %}?course_sis_id=${COURSE_SIS_ID}" class="btn btn-primary btn-block mb-2" target="_self">Vote for a JupyterHub</a>`;
    }
  } else {
    // Hub does not exist and no request found, and is not eligible to request a new hub
    // Don't show buttons that are not actionable
    // buttons += '<button class="btn btn-secondary btn-block mb-2" disabled>Course is not eligible for a JupyterHub</button>';
  }

  // Always show documentation link
  buttons += '<a href="https://uwconnect.uw.edu/it?id=kb_article_view&sysparm_article=KB0034609" class="btn btn-outline-primary btn-block" target="_blank" aria-label="View documentation in new window">View Documentation</a>';

  return buttons;
}

// Load hub data when page loads
document.addEventListener('DOMContentLoaded', function() {
  loadHubData();
});
</script>
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}
