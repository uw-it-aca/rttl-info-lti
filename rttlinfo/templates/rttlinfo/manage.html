<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course Settings</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  {% csrf_token %}
  <style>
    .info-icon {
      color: #17a2b8;
    }
    .form-slider {
      margin-top: 1.5rem;
      margin-bottom: 2rem;
    }
    .slider-label {
      min-width: 60px;
    }
    .error-text {
      color: #dc3545;
    }
    .success-text {
      color: #28a745;
    }
    .subheader {
      background-color: #f8f9fa;
      padding: 0.5rem 1rem;
      font-weight: 500;
      margin-top: 1rem;
    }
  </style>
</head>
<body>

<div class="container my-4">
  <div class="card">
    <div class="card-body">
      <h4 class="subheader">General</h4>
      
      <!-- Image Section -->
      <div class="mb-4">
        <h5>Image</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <select id="imageRepo" class="form-select">
              <option value="" disabled selected>Select image repository</option>
              <!-- Image options would be dynamically populated here -->
            </select>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body d-flex">
                <i class="bi bi-info-circle info-icon me-3 align-self-start"></i>
                <span class="flex-grow-1" id="imageDescription">- none selected -</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-4">
            <input type="text" id="imageTag" class="form-control" placeholder="Image tag">
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body d-flex">
                <i class="bi bi-info-circle info-icon me-3 align-self-start"></i>
                <span class="flex-grow-1" id="displayImageTag"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Lab UI -->
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="labUI" checked>
        <label class="form-check-label" for="labUI">
          <div>Lab UI</div>
          <small class="text-muted">Use the Jupyter Lab Interface</small>
        </label>
      </div>
      
      <!-- Git Puller -->
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="imagePuller">
        <label class="form-check-label" for="imagePuller">
          <div>Git Puller</div>
          <small class="text-muted">Enable nbgitpuller</small>
        </label>
      </div>
      
      <!-- Shared NFS -->
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="featureNFS">
        <label class="form-check-label" for="featureNFS">
          <div>Shared NFS</div>
          <small class="text-muted">Enable a shared NFS folder</small>
        </label>
      </div>
      
      <!-- BinderHub -->
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="featureBinderhub">
        <label class="form-check-label" for="featureBinderhub">
          <div>BinderHub</div>
          <small class="text-muted">Enable BinderHub</small>
        </label>
      </div>
      
      <!-- OIDC Auth flow -->
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="featureOidcauth">
        <label class="form-check-label" for="featureOidcauth">
          <div>OIDC Auth flow</div>
          <small class="text-muted">Enable OIDC auth flow instead of Canvas</small>
        </label>
      </div>
      
      <!-- Skip Canvas course -->
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="featureNocanvas">
        <label class="form-check-label" for="featureNocanvas">
          <div>Skip Canvas course</div>
          <small class="text-muted">Skip associating with Canvas course</small>
        </label>
      </div>
      
      <!-- Spawner -->
      <div class="mb-4">
        <h5>Spawner</h5>
        <div class="row">
          <div class="col-md-4">
            <select id="spawner" class="form-select">
              <option value="jupyter-labhub">jupyter-labhub</option>
              <option value="jupyterhub-singleuser">jupyterhub-singleuser</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Cull Time -->
      <div class="mb-4">
        <h5>Cull Time (seconds)</h5>
        <div class="row">
          <div class="col-md-4">
            <input type="number" id="cullTime" class="form-control" min="600" max="21600" step="60" value="1200">
            <div class="invalid-feedback">Cull Time must be between 600 and 21600.</div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body d-flex">
                <i class="bi bi-info-circle info-icon me-3 align-self-start"></i>
                <span class="flex-grow-1" id="formattedCullTime">0 hour(s) 20 minute(s)</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <hr>
      
      <!-- Resources Section -->
      <h4 class="subheader">Resources</h4>
      
      <!-- Storage Capacity -->
      <div class="mb-4">
        <h5>Storage Capacity</h5>
        <div class="row">
          <div class="col-md-4">
            <select id="storageCapacity" class="form-select">
              <option value="5G">5G</option>
              <option value="10G">10G</option>
              <option value="15G">15G</option>
              <option value="20G">20G</option>
            </select>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body d-flex">
                <i class="bi bi-info-circle info-icon me-3 align-self-start"></i>
                <span class="flex-grow-1">Storage capacity can only be increased.</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- CPU -->
      <div class="mb-4">
        <h5>CPU</h5>
        <div class="row align-items-center form-slider">
          <div class="col-2">
            <span class="slider-label">
              Request
              <div class="fw-bold" id="cpuRequestValue">0.05</div>
            </span>
          </div>
          <div class="col-8">
            <div class="d-flex">
              <input type="range" class="form-range" id="cpuRequest" min="0.05" max="4" step="0.05" value="0.05">
              <input type="range" class="form-range ms-2" id="cpuLimit" min="0.05" max="4" step="0.05" value="4">
            </div>
          </div>
          <div class="col-2 text-end">
            <span class="slider-label">
              Limit
              <div class="fw-bold" id="cpuLimitValue">4.00</div>
            </span>
          </div>
        </div>
      </div>
      
      <!-- Memory -->
      <div class="mb-4">
        <h5>Memory</h5>
        <div class="row align-items-center form-slider">
          <div class="col-2">
            <span class="slider-label">
              Request
              <div class="fw-bold" id="memoryRequestValue">2G</div>
            </span>
          </div>
          <div class="col-8">
            <div class="d-flex">
              <input type="range" class="form-range" id="memoryRequest" min="1" max="4" step="1" value="2">
              <input type="range" class="form-range ms-2" id="memoryLimit" min="1" max="4" step="1" value="4">
            </div>
          </div>
          <div class="col-2 text-end">
            <span class="slider-label">
              Limit
              <div class="fw-bold" id="memoryLimitValue">4G</div>
            </span>
          </div>
        </div>
      </div>
      
      <hr>
      
      <!-- User Content Section -->
      <h4 class="subheader">User Content</h4>
      
      <!-- Extra Env -->
      <div class="mb-4">
        <h5>Extra Env</h5>
        <form id="extraEnvForm" class="row g-3 mb-3">
          <div class="col-md-4">
            <input type="text" class="form-control" id="envKey" placeholder="Key" required>
            <div class="invalid-feedback">Key is required and can only contain A-Z, 0-9 or _</div>
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control" id="envValue" placeholder="Value" required>
          </div>
          <div class="col-md-4">
            <button type="button" class="btn btn-danger me-2" id="resetEnvBtn">
              <i class="bi bi-x-circle"></i>
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-plus-circle"></i>
            </button>
          </div>
        </form>
        
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Key</th>
              <th>Value</th>
              <th class="text-end" style="width: 80px">Actions</th>
            </tr>
          </thead>
          <tbody id="extraEnvTable">
            <!-- Extra env rows will be added dynamically -->
          </tbody>
        </table>
      </div>
      
      <!-- Notebook Git Puller -->
      <div class="mb-4">
        <h5>Notebook Git Puller</h5>
        <form id="gitPullerForm" class="row g-3 mb-3">
          <div class="col-md-4">
            <input type="text" class="form-control" id="gitRepo" placeholder="Git Repo" required>
            <div class="invalid-feedback">Git Repo is required and must be a valid URL.</div>
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" id="gitBranch" placeholder="Branch Name" required>
            <div class="invalid-feedback">Branch Name is required.</div>
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" id="gitTargetDir" placeholder="Target Dir" required>
            <div class="invalid-feedback">Target Dir is required.</div>
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-danger me-2" id="resetGitBtn">
              <i class="bi bi-x-circle"></i>
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-plus-circle"></i>
            </button>
          </div>
        </form>
        
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Repo</th>
              <th>Branch</th>
              <th>Dir</th>
              <th class="text-end" style="width: 80px">Actions</th>
            </tr>
          </thead>
          <tbody id="gitPullerTable">
            <!-- Git puller rows will be added dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<!-- Moment.js for time formatting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Display selected image tag
    const imageTagInput = document.getElementById('imageTag');
    const displayImageTag = document.getElementById('displayImageTag');
    
    imageTagInput.addEventListener('input', function() {
      displayImageTag.textContent = this.value;
    });
    
    // User Placeholders slider
    const placeholderCountSlider = document.getElementById('placeholderCount');
    const placeholderCountValue = document.getElementById('placeholderCountValue');
    const placeholderStatus = document.getElementById('placeholderStatus');
    
    placeholderCountSlider.addEventListener('input', function() {
      placeholderCountValue.textContent = this.value;
      
      if (parseInt(this.value) === 0) {
        placeholderStatus.textContent = 'Disabled';
        placeholderStatus.className = 'error-text';
      } else {
        placeholderStatus.textContent = 'Enabled';
        placeholderStatus.className = 'success-text';
      }
    });
    
    // CPU Sliders
    const cpuRequestSlider = document.getElementById('cpuRequest');
    const cpuLimitSlider = document.getElementById('cpuLimit');
    const cpuRequestValue = document.getElementById('cpuRequestValue');
    const cpuLimitValue = document.getElementById('cpuLimitValue');
    
    cpuRequestSlider.addEventListener('input', function() {
      cpuRequestValue.textContent = parseFloat(this.value).toFixed(2);
      
      // Ensure request doesn't exceed limit
      if (parseFloat(this.value) > parseFloat(cpuLimitSlider.value)) {
        cpuLimitSlider.value = this.value;
        cpuLimitValue.textContent = parseFloat(this.value).toFixed(2);
      }
    });
    
    cpuLimitSlider.addEventListener('input', function() {
      cpuLimitValue.textContent = parseFloat(this.value).toFixed(2);
      
      // Ensure limit doesn't go below request
      if (parseFloat(this.value) < parseFloat(cpuRequestSlider.value)) {
        cpuRequestSlider.value = this.value;
        cpuRequestValue.textContent = parseFloat(this.value).toFixed(2);
      }
    });
    
    // Memory Sliders
    const memoryRequestSlider = document.getElementById('memoryRequest');
    const memoryLimitSlider = document.getElementById('memoryLimit');
    const memoryRequestValue = document.getElementById('memoryRequestValue');
    const memoryLimitValue = document.getElementById('memoryLimitValue');
    
    memoryRequestSlider.addEventListener('input', function() {
      memoryRequestValue.textContent = this.value + 'G';
      
      // Ensure request doesn't exceed limit
      if (parseInt(this.value) > parseInt(memoryLimitSlider.value)) {
        memoryLimitSlider.value = this.value;
        memoryLimitValue.textContent = this.value + 'G';
      }
    });
    
    memoryLimitSlider.addEventListener('input', function() {
      memoryLimitValue.textContent = this.value + 'G';
      
      // Ensure limit doesn't go below request
      if (parseInt(this.value) < parseInt(memoryRequestSlider.value)) {
        memoryRequestSlider.value = this.value;
        memoryRequestValue.textContent = this.value + 'G';
      }
    });
    
    // Cull Time
    const cullTimeInput = document.getElementById('cullTime');
    const formattedCullTime = document.getElementById('formattedCullTime');
    
    function updateFormattedCullTime() {
      const seconds = parseInt(cullTimeInput.value);
      const duration = moment.duration(seconds, 'seconds');
      formattedCullTime.textContent = 
        Math.floor(duration.asHours()) + ' hour(s) ' + 
        duration.minutes() + ' minute(s)';
    }
    
    cullTimeInput.addEventListener('input', function() {
      // Validate
      const value = parseInt(this.value);
      if (value < 600 || value > 21600) {
        this.classList.add('is-invalid');
      } else {
        this.classList.remove('is-invalid');
        updateFormattedCullTime();
      }
    });
    
    // Initialize formatted cull time
    updateFormattedCullTime();
    
    // Extra Env form
    const extraEnvForm = document.getElementById('extraEnvForm');
    const extraEnvTable = document.getElementById('extraEnvTable');
    const resetEnvBtn = document.getElementById('resetEnvBtn');
    
    extraEnvForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const keyInput = document.getElementById('envKey');
      const valueInput = document.getElementById('envValue');
      
      // Validate key (A-Z, 0-9, _)
      if (!keyInput.value || !/^[A-Z0-9_]+$/i.test(keyInput.value)) {
        keyInput.classList.add('is-invalid');
        return;
      }
      
      // Add to table
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${keyInput.value}</td>
        <td>${valueInput.value}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-link delete-env" data-key="${keyInput.value}">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `;
      extraEnvTable.appendChild(row);
      
      // Reset form
      extraEnvForm.reset();
      keyInput.classList.remove('is-invalid');
    });
    
    resetEnvBtn.addEventListener('click', function() {
      extraEnvForm.reset();
      document.getElementById('envKey').classList.remove('is-invalid');
    });
    
    // Delete Extra Env
    document.addEventListener('click', function(e) {
      if (e.target.closest('.delete-env')) {
        const row = e.target.closest('tr');
        row.remove();
      }
    });
    
    // Git Puller form
    const gitPullerForm = document.getElementById('gitPullerForm');
    const gitPullerTable = document.getElementById('gitPullerTable');
    const resetGitBtn = document.getElementById('resetGitBtn');
    
    gitPullerForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const repoInput = document.getElementById('gitRepo');
      const branchInput = document.getElementById('gitBranch');
      const targetDirInput = document.getElementById('gitTargetDir');
      
      // Validate repo URL
      if (!repoInput.value || !isValidHttpUrl(repoInput.value)) {
        repoInput.classList.add('is-invalid');
        return;
      }
      
      // Validate branch and target dir
      if (!branchInput.value) {
        branchInput.classList.add('is-invalid');
        return;
      }
      
      if (!targetDirInput.value) {
        targetDirInput.classList.add('is-invalid');
        return;
      }
      
      // Add to table
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${repoInput.value}</td>
        <td>${branchInput.value}</td>
        <td>${targetDirInput.value}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-link delete-git" 
                  data-repo="${repoInput.value}"
                  data-branch="${branchInput.value}"
                  data-target="${targetDirInput.value}">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `;
      gitPullerTable.appendChild(row);
      
      // Reset form
      gitPullerForm.reset();
      repoInput.classList.remove('is-invalid');
      branchInput.classList.remove('is-invalid');
      targetDirInput.classList.remove('is-invalid');
    });
    
    resetGitBtn.addEventListener('click', function() {
      gitPullerForm.reset();
      document.getElementById('gitRepo').classList.remove('is-invalid');
      document.getElementById('gitBranch').classList.remove('is-invalid');
      document.getElementById('gitTargetDir').classList.remove('is-invalid');
    });
    
    // Delete Git Puller
    document.addEventListener('click', function(e) {
      if (e.target.closest('.delete-git')) {
        const row = e.target.closest('tr');
        row.remove();
      }
    });
    
    // URL validation helper
    function isValidHttpUrl(string) {
      let url;
      try {
        url = new URL(string);
      } catch (_) {
        return false;
      }
      return url.protocol === "http:" || url.protocol === "https:";
    }
  });
</script>
</body>
</html>